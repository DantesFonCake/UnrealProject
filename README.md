# MyProject

Developed with Unreal Engine 4

## Доки
### Модуль MyProject
Содержит по большому счёту источники к первым версиям проекта. В общем их можно считать depreceated. К ним же относится MapDrawer blueprint.

### Модуль CustomFluidShader
Не проверенная частичная реализация compute shader реализации жидкостной симуляции на основе [этой штуки](/StamFluidforGames.pdf). Не проверенно и не про тестированно, но может показать пример использования.

### Модуль ResourceMapModule
Основная рабочая часть проекта. Содержит всю существующую инфрастуктуру для создания, настройки и реализации взаимодействий между слоями. Содержит последнюю реализацию жидкостной симуляции
Пройдёмся по классам:
- `ResourceMapManager` -
    Содержит все созданные слои и экземпляры проходов процессоров. Содержит геттеры для всех типов слоёв (без проверок на наличие), методы для добавления слоёв, проверки на наличие и т.д.
    - `GetNamed**(FName name)` - получает экземпляр слоя по имени. Кинет исключение если не найдёт предоставленного имени.
    - `Add**(FName name, дополнительные параметры)` - добавляет слой/поле[^1] в мэнеджер. Дополнительные параметры определяются типом слоя/поля[^1](об этом позже)
    - `AddProccesorToProccesPass(ITimedLayersProccesor* proccesor)` - добавляет экземпляр процессора в специальный массив
    - `ProccesPass(float DeltaTime)` - проходит и выполняет все процессоры из ранее упомянутого массива
    - `Clear()` - очищает состояние мэнеджера. Чистит все массивы и сэты.
    - `**Exists(FName name)` - проверяет наличие слоя/поля[^1] в мэнеджере
    - `IsDynamic(FName name)` - проверяет является ли слой динамическим. Для поля[^1] вернёт false
- `ResourceMapRendererISMC` - занимается рендером данных мэнеджера в игровой мир с использованием [ISMC](https://docs.unrealengine.com/4.27/en-US/BlueprintAPI/Components/InstancedStaticMesh/)
  - `AddLayerDrawable(FName name, bool isDrawable, Material material, int NumCustomData)` - добавляет слой для отрисовки. Имя должно соответвовать имени слоя из мэнеджера. isDrawable - начальное состояние отрисовки, material - материал который будет использован в меше, NumCustomData - количество float'ов которые можно как дополнительные данные
  - `SetLayerDrawable(FName name, bool visible)` - устанавливает видимость отрисовымаемого слоя.
  - `AddToPreRenderPass(FName name, IPreRenderLayersProccesor* pass)` - добавляет препроцессор к слою. Отрабатывает перед рендером слоя. Используется для установок дополнительных данных (см [`WaterPreRenderProccesor`](./Source/ResourceMapModule/Public/WaterPreRenderProccesor.h))
  - `UpdateFromManager()` - сообственно рендер. Обновляет данные мешей из менеджера.
  - `Clear()` - очишает все данные и удаляет меши.
  - `class UDrawableLayer` - содержит компонент меша, буфер с трансформами инстансов меша (для обновления за раз), а также ряд вспомогательных данных. Открывает минимальный интерфейс для работы с мешем
- `**Layer, VelocityField` - содержит все требуемые данные для обработки слоёв, открывает доступ к подлежащим массивам

### Blueprints
Из всех блюпринтов нас больше всего интересуют 5: `BP_ResourceMapRendererISMC`, `GlobalTimer_Blueprint`, `Rain_Blueprint`, `TickingSunSky`, `MyPlayer`.

Начнём с простого: `GlobalTimer_Blueprint` используется для управлением скоростью симуляции. На самом деле он просто усатнавливает коэффициент времени на который _(должны)_[^2] умножаться DeltaTime тик эвентов и прочее подобное.

После: `MyPlayer` - по сути делает одно - рисует на экран (через виджет) значения трёх основных слоёв (ground, water, temperature) в клетки на которую наведена мышка.

Дальше: `TickingSunSky` копия стандартного `SunSky` актора, но с функционалом динамического изменения текущего времени. Также отвечает за апдейты `Rain_Blueprint` _(по неизвестной мне причине)_.

Потом: сам `Rain_Blueprint`. Отвечает сообственно за дождь. Его положение и размер показывает место положение и границу облаков. Также _(должен)_[^2] отвечать за выпадение осадков, путём инкремента количества жидкости в водном слое, в определённой зоне.

И на конец: `BP_ResourceMapRendererISMC` - отвечает за настройку,обновление и обеспечения доступа к слоям и полям[^1] мира. На данный момент содержит функционал по созданию и инициализации (процедурной генерации) ground слоя, water слоя (изначально добавляет определённое количество жидкости как начальное состояние, добавляет `DiffuseLayersProccesor` в ProccesPass актора и `WaterPreRenderProccesor` к PreRenderPass). Имеется рудиментарное добавление температурного слоя, но за не имением имплементации (на момент написания) оно по сути бесполезно. В Тике вызывается ProccesPass с последующим обновлением состояния для рендера

[^1]: Под полем подразумевается VelocityField
[^2]: Не факт что это так